===== 预发环境 =====
{{{
2021-06-10 14:49:21.700WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : pack in - PurchaserItemRelationExcelBean :	{"areaAttributes":"E","autoSupplement":"0","batchReport":"0","brand":"100161","brandInfo":{"_trantorExtendFields":{},"code":"100161","createdAt":1584972818000,"id":200530,"isDeleted":false,"name":"诗碧曼","updatedAt":1622448694000},"brandSort":"1","businessModel":"1","categroy":"1001","cellStyleMap":{},"country":"CN","dateType":"0","dimensions":"23","electronicWeigherPrint":"0","factoryCode":"000003","hasBox":true,"hasMedium":true,"height_box":"10","height_medium":"10","height_single":"10","importTaxRate":"J0","industryTax":"0","itemATYpe":"12","itemLife":"107","itemName":"新增","itemSimpleName":"新增","length_box":"10","length_medium":"10","length_single":"10","logisticsModel":"10","minOrderQuantity":"9","minQuantity":"12","origin":"107","originAddress":{"address":[{"id":"CN","name":"中国"},{"id":"107","name":"门头沟区"}],"city":{"$ref":"$.originAddress.address[1]"},"province":{"$ref":"$.originAddress.address[0]"}},"originType":"1","outerId":"10010201","packageBarcode_box":"98989888","packageUnit_box":"BA4","packageUnit_medium":"BA3","plannedDeliveryTime":"1","priceControlType":"1","priceManagement":"0","priceSource":"1","priceWithTax":"5","purchaseName":"张三","purchaseOrg":"1000","purchaseTeam":"200","relatedUnitNum_box":"48","relatedUnitNum_medium":"98","relatedUnitNum_single":"1","saleTaxRate":"2","seasonal":"0","selfMadeItem":"1","storageCondition":"0","suggestRetailPrice":"90","supplierOutCode":"60010114","testMarketing":"0","type":"Z004","unifyCode":"202104211645","unit":"B6","uploadQualityReport":"0","weight_box":"10","weight_medium":"10","weight_single":"1","width_box":"10","width_medium":"10","width_single":"10"}
2021-06-10 14:49:21.700WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : pack in - PurchaserItemRelationExcelBean packageNum:	null
2021-06-10 14:49:21.700WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : pack in - itemFromDB :	[ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.91, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=null, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=null, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Wed Jun 09 00:00:00 CST 2021, inspectionReportTime=Wed Jun 09 00:00:00 CST 2021, submitTime=Thu Jun 10 09:29:16 CST 2021, auditTime=null, expirationTime=Mon Dec 06 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=8003_210410002_90000046_PCBG_2_20210413.jpg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/8e6af193-c832-403e-bf67-6ec752699312.jpg, type=jpg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=false, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J8, includeTax=true, saleTaxRate=0, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=SUPPLIER, grossProfitRate=0.95, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=NONE, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=false, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Mon Apr 05 00:00:00 CST 2021, inspectionReportTime=Fri Apr 16 00:00:00 CST 2021, submitTime=Thu Jun 10 08:37:08 CST 2021, auditTime=null, expirationTime=Wed Oct 13 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=Camera Rolltimg-1.jpeg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/e2da5d4f-8d7c-42c2-9883-a5f5e7e3da44.jpeg, type=jpeg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=false, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J1, includeTax=false, saleTaxRate=0, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.50, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=null, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=null, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Wed Jun 09 00:00:00 CST 2021, inspectionReportTime=Wed Jun 09 00:00:00 CST 2021, submitTime=Thu Jun 10 09:15:41 CST 2021, auditTime=null, expirationTime=Mon Dec 06 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=8001_210410002_90000046_PCBG_2_20210411.jpg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/5eac5eaa-db0e-4f33-ae23-17bb1d168364.jpg, type=jpg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=false, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J8, includeTax=true, saleTaxRate=0, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.09, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=NONE, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=false, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Wed Apr 01 00:00:00 CST 2020, inspectionReportTime=Thu Apr 15 00:00:00 CST 2021, submitTime=Wed Apr 21 16:57:06 CST 2021, auditTime=null, expirationTime=Tue Oct 12 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=Camera Rolltimg-1.jpeg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/73f8cbca-b22b-475a-bcd5-1ae7b8884af3.jpeg, type=jpeg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=false, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J1, includeTax=false, saleTaxRate=0, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.77, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=NONE, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=false, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Tue Jun 08 00:00:00 CST 2021, inspectionReportTime=Tue Jun 08 00:00:00 CST 2021, submitTime=Thu Jun 10 11:49:09 CST 2021, auditTime=null, expirationTime=Sun Dec 05 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=8001_210410002_90000046_PCBG_2_20210411.jpg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/769e7a56-563f-40ea-a606-13f1cf94cda4.jpg, type=jpg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=true, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J0, includeTax=true, saleTaxRate=2, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.77, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=NONE, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=false, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Tue Jun 08 00:00:00 CST 2021, inspectionReportTime=Tue Jun 08 00:00:00 CST 2021, submitTime=Thu Jun 10 13:52:40 CST 2021, auditTime=null, expirationTime=Sun Dec 05 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=8001_210410002_90000046_PCBG_2_20210411.jpg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/cdd5a125-a30a-49ff-a02f-ed91f89eb349.jpg, type=jpg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=true, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J0, includeTax=true, saleTaxRate=2, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false), ItemRelation(newItemApply=null, partnerType=PURCHASER, grossProfitRate=0.77, uploadQualityReport=true, qualityCheckStatus=1, qualityReportUploadStatus=uploaded, uploadCertificateReport=NONE, sameUnifiedCodeItemRelations=null, certificateReports=null, hasGeographic=false, hasCooperated=null, geographicAttachments=null, qualityReportBodies=[QualityReportBody(type=third_party_quality_report, productionTime=Tue Jun 08 00:00:00 CST 2021, inspectionReportTime=Tue Jun 08 00:00:00 CST 2021, submitTime=Thu Jun 10 14:17:15 CST 2021, auditTime=null, expirationTime=Sun Dec 05 00:00:00 CST 2021, files=Attachment(files=[Attachment.File(name=8001_210410002_90000046_PCBG_2_20210411.jpg, url=//jjy-b2b-uat.oss-cn-qingdao.aliyuncs.com/trantor/attachments/287864a3-ab9e-4372-93e4-7c06eb6a6227.jpg, type=jpg)]), status=PENDING_EFFECT, auditStatus=WAIT_AUDIT, auditMessage=null, itemRemark=null, itemRelation=null, header=null, result=null, display=false, materialSale=null, supplierCode=null, supplierName=null, materialCode=null, materialName=null, enableCreate=null, available=true, secondCategoryOutCode=null)], customAuditStatus=AUDIT_PASS, auditNotPassReason=null, itemEvaluate=null, result=null, evaluateShops=null, qualityFailReason=null, voider=null, voidTime=null, publishAt=null, importTaxRate=J0, includeTax=true, saleTaxRate=2, wholeSalePrice=22.0000, suggestRetailPrice=22.0000, factoryPrice=null, flag=null, secondCategory=null, supplierCategories=null, isBatch=false)]
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : pack in - index :	2
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 0: done false, num-1
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 1: done false, num-1
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - sap - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 3: done false, num-1
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 4: done false, num-1
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : ir - new - source:NEW_ITEM - customAuditStatus:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : fromNewItem
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : id:7512070, source : NEW_ITEM, status:AUDIT_PASS
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 5: done false, num50.00
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : 6: done false, num50.00
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : getPackageNum out num : 50.00
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : can divide: 48/12 = true
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b2b.scp.action.item.util.ItemUtil : pack out - PurchaserItemRelationExcelBean packageNum:	50.00
2021-06-10 14:49:21.701WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b.s.a.i.a.ItemRelationUploadAction: bean3: {}{"areaAttributes":"E","autoSupplement":"0","batchReport":"0","brand":"100161","brandInfo":{"_trantorExtendFields":{},"code":"100161","createdAt":1584972818000,"id":200530,"isDeleted":false,"name":"诗碧曼","updatedAt":1622448694000},"brandSort":"1","businessModel":"1","categroy":"1001","cellStyleMap":{},"country":"CN","dateType":"0","dimensions":"23","electronicWeigherPrint":"0","factoryCode":"000003","hasBox":true,"hasMedium":true,"height_box":"10","height_medium":"10","height_single":"10","importTaxRate":"J0","industryTax":"0","itemATYpe":"12","itemLife":"107","itemName":"新增","itemSimpleName":"新增","length_box":"10","length_medium":"10","length_single":"10","logisticsModel":"10","minOrderQuantity":"9","minQuantity":"12","origin":"107","originAddress":{"address":[{"id":"CN","name":"中国"},{"id":"107","name":"门头沟区"}],"city":{"$ref":"$.originAddress.address[1]"},"province":{"$ref":"$.originAddress.address[0]"}},"originType":"1","outerId":"10010201","packageBarcode_box":"98989888","packageNum":"50.00","packageUnit_box":"BA4","packageUnit_medium":"BA3","plannedDeliveryTime":"1","priceControlType":"1","priceManagement":"0","priceSource":"1","priceWithTax":"5","purchaseName":"张三","purchaseOrg":"1000","purchaseTeam":"200","relatedUnitNum_box":"48","relatedUnitNum_medium":"98","relatedUnitNum_single":"1","saleTaxRate":"2","seasonal":"0","selfMadeItem":"1","storageCondition":"0","suggestRetailPrice":"90","supplierOutCode":"60010114","testMarketing":"0","type":"Z004","unifyCode":"202104211645","unit":"B6","uploadQualityReport":"0","weight_box":"10","weight_medium":"10","weight_single":"1","width_box":"10","width_medium":"10","width_single":"10"}
2021-06-10 14:49:21.702WARN[jjy-b2b-scp]  - [http-nio-0.0.0.0-8080-exec-3] i.t.j.b.s.a.i.a.ItemRelationUploadAction: 合作质检2 before db: ItemPackage(item=null, itemOutCode=null, form=DP, unit=HE, relatedUnitNum=1, length=1.000, width=1.000, height=1.000, weight=1.000, volume=1.000, packageSpecification=null, packageBarcode=202104211645, unifiedCodeLength=12, distribution=null, unboxing=null, cartonPackage=null, mediumPackage=null, itemCalculate=null, bagsNum=null, source=SCP)

}}}


===== 相关代码 =====
`io.terminus.jjy.b2b.scp.action.item.apply.ItemRelationUploadAction::handleExcel`
{{{#!highlight java
    /**
     * 上传excel的回调
     *
     * @param beans
     */
    public void handleExcel(List<PurchaserItemRelationExcelBean> beans) {
        .
        .
        .
	log.warn("bean3: {}"+excelBean); //根据日志记录证明有箱包
        .
        .
        .
	//itemRelation不为空的时候会造成跳过下边的箱包逻辑
	ItemRelation itemRelation = this.usePackageFormToCheckBarcode(excelBean, line);
        .
        .
        .
	if (Arguments.isNull(itemRelation)) {//itemRelation为空是新品, 非空为老品
	    //加入excel箱包的逻辑
            itemRelation = new ItemRelation();
            Material material = new Material();

            //箱包
            List<ItemPackage> packages = new ArrayList<>();

            //单品
            packages.add();
            //中包
            packages.add();
            //箱包
            packages.add();

            material.set(Item.itemPackages_field, packages);
            itemRelation.setMaterial(material);
	}
        .
        .
        .
        //此时itemRelation仅有db中的箱包数据, 并无excelBean的箱包数据
	//保存的逻辑
	itemService.importItemRelations(itemRelations);

    }
}}}

`io.terminus.jjy.b2b.scp.action.item.apply.ItemRelationUploadAction::usePackageFormToCheckBarcode`
{{{#!highlight java
    private ItemRelation usePackageFormToCheckBarcode(PurchaserItemRelationExcelBean excelBean, int line) {
	
	String unifyCode = excelBean.getUnifyCode();
	ItemRelation itemRelation = null;
        .
        .
        .
	//excel中的unifyCode为空itemRelation是空, excel中的unifyCode非空itemRelation为查询DB
	if (Arguments.notEmpty(unifyCode)) {
	    itemRelation = this.itemRelationMap.get(unifyCode);
	}
        .
        .
        .
	return itemRelation;
    }
}}}
